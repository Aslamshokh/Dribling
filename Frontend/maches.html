<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dribbling - –ú–∞—Ç—á–∏</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="header">
        <div class="header-title">–í—Å–µ –º–∞—Ç—á–∏</div>
        <div>
            <i class="fas fa-map-marker-alt" style="color: var(--accent-green);"></i>
            <span id="selected-city">–ü–µ–Ω–¥–∂–∏–∫–µ–Ω—Ç</span>
        </div>
    </div>

    <div class="container">
        <div class="filters" id="city-filters">
            <span class="filter-chip active" data-city="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</span>
            <span class="filter-chip" data-city="–ü–µ–Ω–¥–∂–∏–∫–µ–Ω—Ç">–ü–µ–Ω–¥–∂–∏–∫–µ–Ω—Ç</span>
            <span class="filter-chip" data-city="–•—É–¥–∂–∞–Ω–¥">–•—É–¥–∂–∞–Ω–¥</span>
            <span class="filter-chip" data-city="–î—É—à–∞–Ω–±–µ">–î—É—à–∞–Ω–±–µ</span>
        </div>

        <div class="filters" id="format-filters">
            <span class="filter-chip active" data-format="">–í—Å–µ —Ñ–æ—Ä–º–∞—Ç—ã</span>
            <span class="filter-chip" data-format="5x5">5x5</span>
            <span class="filter-chip" data-format="7x7">7x7</span>
            <span class="filter-chip" data-format="11x11">11x11</span>
        </div>

        <div style="margin-bottom: 16px;">
            <input type="date" id="date-filter" class="form-input" style="background: var(--bg-card);">
        </div>

        <div id="matches-list" class="loading">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="profile.html" class="nav-item">
            <i class="fas fa-user"></i>
            <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </a>
        <a href="matches.html" class="nav-item active">
            <i class="fas fa-futbol"></i>
            <span>–ú–∞—Ç—á–∏</span>
        </a>
        <a href="create-match.html" class="nav-item">
            <i class="fas fa-plus-circle"></i>
            <span>–°–æ–∑–¥–∞—Ç—å</span>
        </a>
    </nav>

    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/app.js"></script>
    <script>
        let currentFilters = {
            city: '',
            format: '',
            date: ''
        };

        document.addEventListener('DOMContentLoaded', async () => {
            setupFilters();
            await loadMatches();
        });

        function setupFilters() {
            document.querySelectorAll('#city-filters .filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('#city-filters .filter-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentFilters.city = chip.dataset.city;
                    loadMatches();
                });
            });

            document.querySelectorAll('#format-filters .filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('#format-filters .filter-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    currentFilters.format = chip.dataset.format;
                    loadMatches();
                });
            });

            document.getElementById('date-filter').addEventListener('change', (e) => {
                currentFilters.date = e.target.value;
                loadMatches();
            });
        }

        async function loadMatches() {
            const container = document.getElementById('matches-list');
            container.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';

            try {
                const filters = {};
                if (currentFilters.city) filters.city = currentFilters.city;
                if (currentFilters.format) filters.format = currentFilters.format;
                if (currentFilters.date) filters.date = currentFilters.date;
                
                const matches = await api.getMatches(filters);
                
                if (matches.length === 0) {
                    container.innerHTML = '<p class="text-center" style="color: var(--text-secondary);">–ú–∞—Ç—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                    return;
                }

                container.innerHTML = '';
                matches.forEach(match => {
                    const matchCard = document.createElement('div');
                    matchCard.className = 'card match-card';
                    matchCard.onclick = () => navigateTo(`match-detail.html?id=${match.id}`);
                    
                    const isFull = (match.players_count || 0) >= match.max_players;
                    const status = match.status === 'finished' ? '–ó–∞–≤–µ—Ä—à–µ–Ω' : 
                                  isFull ? '–ó–∞–ø–æ–ª–Ω–µ–Ω–æ' : '–û—Ç–∫—Ä—ã—Ç';
                    
                    matchCard.innerHTML = `
                        <div class="match-title">${match.title}</div>
                        <div class="match-info">
                            <span class="match-info-item">
                                <i class="fas fa-map-marker-alt"></i> ${match.stadium}
                            </span>
                            <span class="match-info-item">
                                <i class="fas fa-calendar"></i> ${formatDate(match.date_time)}
                            </span>
                            <span class="match-info-item">
                                <i class="fas fa-users"></i> ${match.format}
                            </span>
                        </div>
                        <div class="match-players">
                            <span>üë• ${match.players_count || 0}/${match.max_players}</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${((match.players_count || 0) / match.max_players) * 100}%"></div>
                            </div>
                            <span class="btn btn-small ${!isFull && match.status === 'open' ? 'btn-outline' : ''}" 
                                  style="${isFull || match.status !== 'open' ? 'background: var(--border-color); color: var(--text-secondary);' : ''}">
                                ${status}
                            </span>
                        </div>
                    `;
                    
                    container.appendChild(matchCard);
                });
            } catch (error) {
                console.error('Error loading matches:', error);
                container.innerHTML = '<p class="text-center text-green">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç—á–µ–π</p>';
            }
        }
    </script>
</body>
</html>